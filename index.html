<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Inventario Suc 2860</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{margin:0;font-family:'Segoe UI',sans-serif;background:linear-gradient(135deg,#e3f2fd,#bbdefb);}
header{background:white;padding:12px 16px;display:flex;flex-wrap:wrap;justify-content:space-between;align-items:center;box-shadow:0 4px 20px rgba(0,0,0,0.1);gap:10px;}
.logo{width:100px}
.container{max-width:1100px;margin:auto;padding:15px;}
.card{background:white;border-radius:16px;padding:18px;margin-bottom:18px;box-shadow:0 10px 25px rgba(0,0,0,0.1);}
.producto{display:flex;flex-wrap:wrap;align-items:center;gap:12px;padding:12px;border-radius:12px;background:#f7fbff;margin:10px 0;}
.producto img{width:70px;height:70px;border-radius:10px;background:white;object-fit:contain;padding:5px;}
button{background:linear-gradient(135deg,#1976d2,#42a5f5);color:white;border:none;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600;margin:4px;}
button:active{transform:scale(.97)}
input{padding:8px;border-radius:8px;border:1px solid #ccc;max-width:140px;}
.login{max-width:320px;margin:80px auto;text-align:center;}
@media (max-width:600px){
header{flex-direction:column;text-align:center}
.producto{flex-direction:column;align-items:flex-start}
.producto img{width:100%;max-width:120px;height:auto}
input{max-width:100%}
button{width:100%}
}
</style>
</head>

<body>

<audio id="sndClick" preload="auto">
<source src="https://cdn.pixabay.com/download/audio/2022/03/10/audio_0f4a0c1b9b.mp3">
</audio>

<audio id="sndPop" preload="auto">
<source src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_efc9c5e0b9.mp3">
</audio>

<div id="loginBox" class="card login">
<h2>Acceso al sistema</h2>
<input id="usuario" placeholder="Usuario"><br><br>
<input id="password" type="password" placeholder="ContraseÃ±a"><br><br>
<button onclick="sonidoClick();login()">Ingresar</button>
<p id="error" style="color:red"></p>
</div>

<div id="sistema" style="display:none">

<header>
<div>
<img src="logo.png" class="logo">
<h3>Sucursal 2860</h3>
</div>
<div>
<span id="usuarioActivo"></span>
<button onclick="sonidoClick();logout()">Cerrar sesiÃ³n</button>
</div>
</header>

<div class="container">

<div class="card">
<h3>Productos</h3>
<div id="zonaAgregar"></div>
<div id="listaProductos"></div>
</div>

<div class="card">
<h3>Mi conteo</h3>
<button onclick="sonidoClick();mostrarConteo()">Ver mi conteo</button>
<button onclick="sonidoClick();exportarPDF()">Exportar PDF</button>
<div id="resultado"></div>
</div>

<div class="card" id="buzonAlma" style="display:none">
<h3>ðŸ“¥ BuzÃ³n de reportes</h3>
<div id="listaReportes"></div>
</div>

</div>
</div>

<script>
const { jsPDF } = window.jspdf;

function sonidoClick(){const s=document.getElementById("sndClick");s.currentTime=0;s.play().catch(()=>{});}
function sonidoPop(){const s=document.getElementById("sndPop");s.currentTime=0;s.play().catch(()=>{});}

const usuarios={
"497271":"suc2860","Miros":"empleado1","Juan":"empleado2",
"Antonio":"empleado3","Lupita":"empleado4","Yezica":"empleado5",
"Alan":"empleado6","Getse":"empleado7","Alma":"Jefa1",
"Melissa":"Jefa3","Jonathan":"Jefe2","Gio":"Nocturno1",
"Alexia":"Empleado8","Gladis":"Empleado9","Ale":"Empleado10",
"Chris":"Empleado11","Ivette":"Empleado12","Lluvia":"Empleado13",
"Tania":"Empleado14"
};

const puedeEditar=["497271","Alma"];
let productos=JSON.parse(localStorage.getItem("productos2860"))||[];
let usuarioActual=null;
let conteos={};

function guardarProductos(){localStorage.setItem("productos2860",JSON.stringify(productos));}
function guardarConteos(){localStorage.setItem("conteo_"+usuarioActual,JSON.stringify(conteos));}
function cargarConteos(){conteos=JSON.parse(localStorage.getItem("conteo_"+usuarioActual))||{};}

function login(){
const u=usuario.value,p=password.value;
if(usuarios[u]&&usuarios[u]===p){
usuarioActual=u;
cargarConteos();
loginBox.style.display="none";
sistema.style.display="block";
usuarioActivo.textContent="Usuario: "+u;
cargarVista();
}else error.textContent="Datos incorrectos";
}

function logout(){location.reload();}

function cargarVista(){
zonaAgregar.innerHTML="";
if(puedeEditar.includes(usuarioActual)){
const btn=document.createElement("button");
btn.textContent="Agregar producto";
btn.onclick=()=>{sonidoClick();agregarProducto();};
zonaAgregar.appendChild(btn);
}
renderProductos();

if(usuarioActual==="Alma"){
document.getElementById("buzonAlma").style.display="block";
cargarReportesAlma();
}
}

function renderProductos(){
listaProductos.innerHTML="";
productos.forEach((p,i)=>{
setTimeout(()=>sonidoPop(),100);
const cantidad=conteos[i]||0;
let admin="";
if(puedeEditar.includes(usuarioActual)){
admin=`
<input type="file" accept="image/*" onchange="cambiarImagen(${i},this)">
<button onclick="sonidoClick();eliminarProducto(${i})">Borrar</button>`;
}
const div=document.createElement("div");
div.className="producto";
div.innerHTML=`
<img src="${p.img}">
<b>${p.nombre}</b>
Mi conteo:
<input type="number" value="${cantidad}" min="0"
onchange="actualizarMiConteo(${i},this.value)">
${admin}`;
listaProductos.appendChild(div);
});
}

function cambiarImagen(i,input){
const file=input.files[0];
if(file){
const reader=new FileReader();
reader.onload=e=>{
productos[i].img=e.target.result;
guardarProductos();
cargarVista();
};
reader.readAsDataURL(file);
}
}

function agregarProducto(){
sonidoPop();
const div=document.createElement("div");
div.className="producto";
div.innerHTML=`
<input type="file" accept="image/*">
<img style="display:none">
<input type="text" placeholder="Nombre">
<button onclick="sonidoClick();guardarProducto(this)">Guardar</button>`;
const fileInput=div.querySelector("input[type=file]");
const img=div.querySelector("img");
fileInput.addEventListener("change",e=>{
const reader=new FileReader();
reader.onload=ev=>{img.src=ev.target.result;img.style.display="block";}
reader.readAsDataURL(e.target.files[0]);
});
listaProductos.prepend(div);
}

function guardarProducto(btn){
const cont=btn.parentElement;
const nombre=cont.querySelector("input[type=text]").value;
const img=cont.querySelector("img").src;
if(!nombre||!img){alert("Completa datos");return;}
productos.push({nombre,img});
guardarProductos();
cargarVista();
}

function actualizarMiConteo(i,c){conteos[i]=c;guardarConteos();}
function eliminarProducto(i){
if(confirm("Eliminar producto para todos?")){
productos.splice(i,1);
guardarProductos();
cargarVista();
}
}

function mostrarConteo(){
resultado.innerHTML="<b>Mi conteo:</b><br>";
productos.forEach((p,i)=>{
resultado.innerHTML+=`${p.nombre} â€” ${conteos[i]||0}<br>`;
});
}

/* BUZON ALMA */
function guardarReporteParaAlma(nombreUsuario, pdfBase64){
let reportes = JSON.parse(localStorage.getItem("reportesAlma2860")) || [];
reportes.push({usuario:nombreUsuario,fecha:new Date().toLocaleString(),archivo:pdfBase64});
localStorage.setItem("reportesAlma2860", JSON.stringify(reportes));
}

function cargarReportesAlma(){
const cont=document.getElementById("listaReportes");
let reportes=JSON.parse(localStorage.getItem("reportesAlma2860"))||[];
cont.innerHTML="";
if(reportes.length===0){cont.innerHTML="No hay reportes aÃºn";return;}

reportes.reverse().forEach((r,index)=>{
const btn=document.createElement("button");
btn.textContent=`Abrir reporte de ${r.usuario} (${r.fecha})`;
btn.onclick=()=>descargarReporte(r.archivo);

const borrar=document.createElement("button");
borrar.textContent="âŒ";
borrar.onclick=()=>eliminarReporte(index);

cont.appendChild(btn);
cont.appendChild(borrar);
cont.appendChild(document.createElement("br"));
});
}

function eliminarReporte(index){
let reportes=JSON.parse(localStorage.getItem("reportesAlma2860"))||[];
reportes.splice(reportes.length-1-index,1);
localStorage.setItem("reportesAlma2860",JSON.stringify(reportes));
cargarReportesAlma();
}

function descargarReporte(base64){
const link=document.createElement("a");
link.href=base64;
link.download="reporte_conteo.pdf";
link.click();
}

function exportarPDF(){
sonidoClick();
const doc=new jsPDF();
doc.text("Conteo - Sucursal 2860",20,20);
doc.text("Empleado: "+usuarioActual,20,30);
let y=45;
productos.forEach((p,i)=>{
doc.text(`${p.nombre} - ${conteos[i]||0}`,20,y);
y+=10;
});
doc.save("mi_conteo.pdf");
const pdfBase64=doc.output("datauristring");
guardarReporteParaAlma(usuarioActual,pdfBase64);
}
</script>

</body>
</html>